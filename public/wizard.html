<html>
    <head>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link href="/styles/jsoneditor.min.css" rel="stylesheet" type="text/css">
    <script src="/js/jsoneditor.min.js"></script>
        <script
          src="https://code.jquery.com/jquery-3.4.1.min.js"
          integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
          crossorigin="anonymous">
      </script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="js/wizard.js"></script>
        <script>

	</script>
    </head>
    <body>
        <div class="container">
            <div class="row">
                <button type="button" class="btn btn-success"> 
                    <a href="#" data-toggle="modal" data-target="#updateStorefront" style="color:white"> Change storefront in use </a>
                </button>
            </div>
            <br>
            <br>



<!-- Update Storefront Modal -->
    <div class="modal fade" id="updateStorefront" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" >
         <div class="modal-dialog" role="document">
            <div class="modal-content">
               <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">Change storefront</h4>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                  </button>
               </div>
               <div class="modal-body">
                   <div class="accordion" id="store-accordion">
                       <div class="card">
                           <div class="card-header" id="headingTwo">
                               <h2 class="mb-0">
                                   <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                       Add custom storefront
                                   </button>
                               </h2>
                           </div>
                           <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#store-accordion">
                               <div class="card-body">
                                   <form id="popupFormStorefront" name="popupFormStorefront" onsubmit="setCustomStorefront(); return false;" class="needs-validation" novalidate>
                                       <div class="form-group">
                                           <label for="storefrontId" class="col-form-label">Storefront Id:</label>
                                           <input type="text" class="form-control" id="storefrontId" name="storefrontId" required="required"
                                                                                                                         pattern="^[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,5}(\/[a-z0-9-]*)?$"
                                                                                                                         title="....test.onfastspring.com...">
                                           <div class="invalid-feedback"> Please insert a valid storefrontId</div>
                                       </div>
                                       <div class="form-group">
                                           <label for="accessKey" class="col-form-label"> Access Key:</label>
                                           <input class="form-control" type="text" id="accessKey" name="accessKey" pattern=".{22,}" required="required">
                                           <div class="invalid-feedback"> Please insert a valid 22 characters access key</div>
                                       </div>
                                       <button type="submit" class="btn btn-primary" id="addStorefrontBtn"> Add </button>
                                   </form>
                               </div>
                           </div>
                       </div>
                   </div>
                </div>
                <div class="modal-footer">
                    <button disabled type="button" class="btn btn-primary" data-step="initial" id="goToKeysForm"> Next </button>
                </div>
            </div>
         </div>
   </div>









            <div class="row">
                <div class="col-6">
                    <div id='raw-code'>
                        <form id="formRawPayload" name="formRawPayload" onsubmit="return false;" class="needs-validation" novalidate="">
                            <div class="form-row">
                                <h5> Raw payload </h5>
                                <div id="jsoneditor" style="width: 400px; height: 400px;"></div>
                <button onclick="createJSON()"> click </button>
                <!--
                                <textarea class="form-control" name="payload" rows="13">
{
    "contact": {
        "email": "myName@email.com",
        "firstName": "John",
        "lastName": "Doe"
    },
    "items": [
        {
            "product": "phot-io-main-app",
            "quantity": 1
        }
    ]   
}
                                </textarea>
                -->
                            </div>
                        </form>
                        <button type="button" class="btn btn-primary" onclick="encryptPayload()">
                            Encrypt Payload
                        </button>

                    </div>
                    <br/>
                    <h5> Encrypted payload </h5>
                    <div class="card card-body" style="background-color: #8080800d;">
                        <pre>
                            <code id="encrypted-code">
                           </code>
                           </pre>
                       </div>
                       <button type="button" class="btn btn-primary" onclick="secureCall()">
                            Execute
                        </button>
                </div>
                <div class="col-6">
                    <button type="button" class="btn btn-primary" onclick="createKeys2()">
                        Create new keys
                    </button>

                    <div id='keys-container'>
                        <div id="accordion"
                        <div class="card">
                            <div class="card-header" id="headingOne">
                                <h5 class="mb-0">
                                    <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                        Private Key
                                    </button>
                                </h5>
                            </div>

                            <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordion">
                                <div class="card-body privateKey" id='privateKey'>
                                  
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header" id="headingTwo">
                                <h5 class="mb-0">
                                    <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                        Public Certificate
                                    </button>
                                </h5>
                            </div>
                            <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordion">
                                <div class="card-body publicKey" id='publicKey'>
                                    
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>

        <div class="modal fade bd-example-modal-lg" id="createKeysModal" tabindex="-1" role="dialog" aria-labelledby="createKeysModal" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="keys-modal-title"> Keys </h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div id="charge-form-wrapper">
                        <div class="modal-body" >
                            <div id="initial-container">
                                <p> Thanks for selecting your storefront.</p>
                                <p>
                                The process of passing data securely through SBL requires a pair of private and public keys which will be used to encrypt the payload containing
                                the custom buyer's shopping cart. FastSpring instantly decrypts this payload upon receipt and applies the decrypted data to the current session.
                                This is why, as a first step, you need to define this keys pair. Please select one of the below option:
                                </p>

                                <form name="keys-form" id="keys-form">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="radio-keys" value="new-keys-result">
                                        <label class="form-check-label" for="exampleRadios1">
                                            I need to create new keys
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="radio-keys" value="existing-keys">
                                        <label class="form-check-label" for="exampleRadios1">
                                            I already have a private key and a public cert uploaded in my dashboard
                                        </label>
                                    </div>
                                </form>
                            </div>
                            <div id="existing-keys-container" style="display:none">
                                Please paste your key here:
                                <form name="custom-key-form" id="keys-form">
                                    <textarea class="form-control" name="custom-privateKey" rows="13">
                                    </textarea>
                                </form>
                            </div>
                            <div id="new-keys-result-container">
                                <p> Please now proceed to securely store the private key in your system and upload the public certificate to your dashboard. </p>
                                
                                <p> Once you have done, the next step is to create the payload representing the custom buyer's session. Click on the "Next" button when ready.</p>
                            
                                <div id="accordion"
                                    <div class="card">
                                        <div class="card-header" id="headingOne">
                                            <h5 class="mb-0">
                                                <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOneNew" aria-expanded="true" aria-controls="collapseOneNew">
                                                    Private Key
                                                </button>
                                            </h5>
                                        </div>

                                        <div id="collapseOneNew" class="collapse" aria-labelledby="headingOneNew" data-parent="#accordion">
                                            <div class="card-body privateKey">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card">
                                        <div class="card-header" id="headingTwo">
                                            <h5 class="mb-0">
                                                <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseTwoNew" aria-expanded="false" aria-controls="collapseTwoNew">
                                                    Public Certificate
                                                </button>
                                            </h5>
                                        </div>
                                        <div id="collapseTwoNew" class="collapse" aria-labelledby="headingTwoNew" data-parent="#accordion">
                                            <div class="card-body publicKey">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                </div>
                        </div>
                        <div class="modal-footer">
                            <button disabled type="button" class="btn btn-primary" data-step="initial" id="createKeysBtn"> Next </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="modal fade bd-example-modal-lg" id="publicCrtModal" tabindex="-1" role="dialog" aria-labelledby="publicCrtModal" aria-hidden="true">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel"> Upload your public certificate </h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div id="charge-form-wrapper">
                            <div class="modal-body" style="text-align: center;">
                                <p> Great! Please now proceed to upload the public certificate to your dashboard. </p>
                                <pre id="publicKey-modal"> </p>
                                <p> Make sure to keep your private key stored secretly.. </p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-dismiss="modal"> Done! </button>
                            </div>
                        <div>
                    </div>
                </div>
            </div>


    <script>

        function dataCallback() {
            if (changingStorefront) {
                $('#goToKeysForm').removeAttr("disabled");
                $('#updateStorefront').modal('hide');
                $('#createKeysModal').modal('show');
            }
        }

        function dataErrorCallback2(code, string) {
            if (code === 0) {
                alert('Incorrect storefront'); 
            }
        }
        
        // create the editor
        
        function createJSON() {

        const container = document.getElementById("jsoneditor")
        const options = {
            mode: 'code',
            onError: function (err) {
                alert(err.toString())
            },
            onModeChange: function (newMode, oldMode) {
                console.log('Mode switched from', oldMode, 'to', newMode)
            }
        };
        const editor = new JSONEditor(container, options)

        // set json
        const initialJson = {
            "Array": [1, 2, 3],
            "Boolean": true,
            "Null": null,
            "Number": 123,
            "Object": {"a": "b", "c": "d"},
            "String": "Hello World"
        }
        editor.set(initialJson)
        console.log(editor);
        }
            </script>
    
        <script>
            

            function createKeys2() {
                $('#createKeysModal').modal('show');
            }

            function createKeys() {
                $.post(`${window.location.origin}/keys/new`)
                    .done((resKey) => {
                        if (resKey) {
                            $('#privateKey').html(`<pre> ${resKey.privateKey} </pre>`);
                            $('#publicKey').html(`<pre> ${resKey.publicCrt} </pre>`);
                            $('#publicKey-modal').html(resKey.publicCrt);
                            $('#publicCrtModal').modal('show');
                        } else {
                            console.log('eerr');
                        }
                    })
                    .fail(() => {
                        forceLogout('An unexpected server error occurred, please login again.');
                    });
            }

            function encryptPayload() {
                const rawPayload = document.getElementById('formRawPayload').payload.value;
                // First check that it's a valid payload
                const isValidJSON = (payload) => {
                    try {
                        JSON.parse(rawPayload);
                    } catch (e) {
                        console.log(e.message, e.name);
                        return false;
                    }
                    return true;
                };
                alert(isValidJSON(rawPayload));
                return;

                const JSONpayload = JSON.parse(rawPayload);
                console.log(JSONpayload);
                // Create AJAX request to our backend
                    
                const Http = new XMLHttpRequest();
                    const url= `${window.location.origin}/encrypt`;
                    Http.open('POST', url, true);
                    Http.setRequestHeader("Content-Type", "application/json");
                   
                    Http.onreadystatechange = function(){
                        if (this.readyState === 4 && this.status === 200) {
                        const resEncrypted = JSON.parse(this.responseText);
                        
                        $('#encrypted-code').html(`
const securePayload = "${resEncrypted.securePayload}";
const secureKey = "${resEncrypted.secureKey}";

fastspring.builder.secure(securePayload, secureKey);
fastspring.builder.checkout();`);
}
                    };
                    Http.send(JSON.stringify(JSONpayload));
/*
                $.post(`${window.location.origin}/encrypt`, JSONpayload )
                    .done((resEncrypted) => {
                        if (resEncrypted) {
                        $('#encrypted-code').html(`
const securePayload = "${resEncrypted.securePayload}";
const secureKey = "${resEncrypted.secureKey}";

fastspring.builder.secure(securePayload, secureKey);
fastspring.builder.checkout();`);
                        } else {
                            console.log('eerr');
                        }
                    })
                    .fail(() => {
                        forceLogout('An unexpected server error occurred, please login again.');
                    });
                    */
            }

            function secureCall() {
                eval($("#encrypted-code").html());
            }
        </script>
    </body>
</html>
