<html>
    <head>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link href="/styles/jsoneditor.min.css" rel="stylesheet" type="text/css">
        <link href="/styles/custom.css" rel="stylesheet" type="text/css">
        <script src="/js/jsoneditor.min.js"></script>
        <script
          src="https://code.jquery.com/jquery-3.4.1.min.js"
          integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
          crossorigin="anonymous">
      </script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="js/secure.js"></script>
        <script>

        /*
            Default 
        */
		const config =  {
			storefronts: [
                "fastspringexamplesii.test.onfastspring.com/popup-fastspringexamplesii",
				"fastspringexamplesii.test.onfastspring.com"
			],
			accessKey: "K2HOU37OQS6HQGRD5I2ZEG"
		};

        /*
            When page is loaded check localStorage to determine whether we are using the 
            default fastspringexamples storefronts or a custom one from the user
        */

		const storefrontToUse = sessionStorage.getItem('FSsecure-storefrontToUse') || config.storefronts[0];
        let accessKeyToUse = config['accessKey'];
        if (config.storefronts.indexOf(storefrontToUse) < 0 && sessionStorage.getItem('FSsecure-accessKeyToUse')) {
            accessKeyToUse = sessionStorage.getItem('FSsecure-accessKeyToUse');
        }
        
        document.write(
            '<scr' + 'ipt ' + `
                id="fsc-api"
                src="https://d1f8f9xcsvx3ha.cloudfront.net/sbl/0.8.0/fastspring-builder.min.js" type="text/javascript"
                data-storefront=${storefrontToUse}
                data-markup-helpers-callback="markupHelpersCallback"
                data-before-requests-callback="beforeRequestsCallback"
                data-after-requests-callback="afterRequestsCallback"
                data-after-markup-callback="afterMarkupCallback"
                data-popup-closed="popupClosed"
                data-decorate-callback="decorateCallback"
                data-error-callback="errorCallback"
                data-data-callback="dataCallback"
                data-access-key=${accessKeyToUse}
              > ` + 
            '<\/scr' + 'ipt>'
        );

	</script>
    </head>
    <body>
        <div class="container">
            <header class="blog-header py-3">
                <div class="row justify-content-center">
                    <div class="col offset-md-4">
                        <a href="https://fastspring.com" target="_blank" style="color: transparent;">
                            <img src="images/fastspring-logo.png" alt="homepage" class="fs-logo">
                        </a>
                    </div>
                </div>
            </header>

            <div class="row">
                <div class="col-6">
                    <div id='raw-code'>
                        <div class="row">
                            <div id="jsoneditor" class="col-12" style="height: 400px"></div>
                            </div>
                        <button type="button" class="btn btn-primary" id='encryptButton' onclick="encryptPayload()">
                            Encrypt Payload
                        </button>

                    </div>
                    <br/>
                    <div class="card card-body" style="background-color: #8080800d;">
                        <pre>
                            <code id="encrypted-code">
                           </code>
                           </pre>
                       </div>
                       <button type="button" class="btn btn-primary" onclick="secureCall()">
                            Execute
                        </button>
                </div>
                <div class="col-6">
                    <div id='instructions-container'>
                        <div class="card">
                            <div class="card-header" id="headingOne">
                                <b> Welcome to the Encryption Playground </b>
                            </div>
                            <div class="card-body">
                                <p>
                
                                    The aim of this tool is to interactively learn how to create custom sessions using the secure method of the Store Builder Library.
                                </p>
                                <h5> How does it work? </h5>
                                <p>
                                    Use the JSON editor at the left to create your custom payload.
                                    If the payload is sintactically valid it will be sent to the backend for encryption
                                </p>
                                <h5> Testing with your own storefront  </h5>
                                    <p>
                                    This tool provides a Wizard that will walk you through the steps you need to implement encrypted payloads on your website.
                                    </p>
                                <button type="button" class="btn btn-success"> 
                                    <a href="/wizard.html" style="color:white">
                                        Take me to the Wizard 
                                    </a>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Update Storefront Modal -->
    <div class="modal fade" id="updateStorefront" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" >
         <div class="modal-dialog" role="document">
            <div class="modal-content">
               <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">Change storefront</h4>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                  </button>
               </div>
               <div class="modal-body">
                   <div class="accordion" id="store-accordion">
                       <div class="card">
                           <div class="card-header" id="headingOne">
                               <h2 class="mb-0">
                                   <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                       Select available storefronts
                                   </button>
                               </h2>
                           </div>
                                
                           <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#store-accordion">
                               <div class="card-body">
                                   <form name="storefronts" id="storefronts">
                                        <!-- Radio inputs will be generated automatically -->
                                   </form>
                               </div>
                           </div>
                       </div>
                       <div class="card">
                           <div class="card-header" id="headingTwo">
                               <h2 class="mb-0">
                                   <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                       Add custom storefront
                                   </button>
                               </h2>
                           </div>
                           <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#store-accordion">
                               <div class="card-body">
                                   <form id="popupFormStorefront" name="popupFormStorefront" onsubmit="setCustomStorefront(); return false;" class="needs-validation" novalidate>
                                       <div class="form-group">
                                           <label for="storefrontId" class="col-form-label">Storefront Id:</label>
                                           <input type="text" class="form-control" id="storefrontId" name="storefrontId" required="required"
                                                                                                                         pattern="^[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,5}(\/[a-z0-9-]*)?$"
                                                                                                                         title="....test.onfastspring.com...">
                                           <div class="invalid-feedback"> Please insert a valid storefrontId</div>
                                       </div>
                                       <div class="form-group">
                                           <label for="accessKey" class="col-form-label"> Access Key:</label>
                                           <input class="form-control" type="text" id="accessKey" name="accessKey" pattern=".{22,}" required="required">
                                           <div class="invalid-feedback"> Please insert a valid 22 characters access key</div>
                                       </div>
                                       <button type="submit" class="btn btn-primary" id="addStorefrontBtn"> Add </button>
                                   </form>
                               </div>
                           </div>
                       </div>
                   </div>
               </div>
            </div>
         </div>
   </div>


        <div class="modal fade bd-example-modal-lg" id="createKeysModal" tabindex="-1" role="dialog" aria-labelledby="createKeysModal" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="keys-modal-title"> Keys </h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div id="charge-form-wrapper">
                        <div class="modal-body" >
                            <div id="initial-container">
                                <p> Thanks for selecting your storefront.</p>
                                <p>
                                The process of passing data securely through SBL requires a pair of private and public keys which will be used to encrypt the payload containing
                                the custom buyer's shopping cart. FastSpring instantly decrypts this payload upon receipt and applies the decrypted data to the current session.
                                This is why, as a first step, you need to define this keys pair. Please select one of the below option:
                                </p>
                                <form name="keys-form" id="keys-form">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="radio-keys" value="new-keys-result">
                                        <label class="form-check-label" for="exampleRadios1">
                                            I need to create new keys
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="radio-keys" value="existing-keys">
                                        <label class="form-check-label" for="exampleRadios1">
                                            I already have a private key and a public cert uploaded in my dashboard
                                        </label>
                                    </div>
                                </form>
                            </div>
                            <div id="existing-keys-container" style="display:none">
                                Please paste your key here:
                                <form name="custom-key-form" id="keys-form">
                                    <textarea class="form-control" name="custom-privateKey" rows="13">
                                    </textarea>
                                </form>
                            </div>
                            <div id="new-keys-result-container" style="display:none;text-align: center;">
                                <p> Great! Please now proceed to securely store the private key in your system and upload the public certificate to your dashboard. </p>
                                
                                <p> Once you have done, the next step is to create the payload representing the custom buyer's session. Click on the "Next" button when ready.</p>
                            
                                <div id="accordion"
                                    <div class="card">
                                        <div class="card-header" id="headingOne">
                                            <h5 class="mb-0">
                                                <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOneNew" aria-expanded="true" aria-controls="collapseOneNew">
                                                    Private Key
                                                </button>
                                            </h5>
                                        </div>

                                        <div id="collapseOneNew" class="collapse" aria-labelledby="headingOneNew" data-parent="#accordion">
                                            <div class="card-body privateKey">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card">
                                        <div class="card-header" id="headingTwo">
                                            <h5 class="mb-0">
                                                <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseTwoNew" aria-expanded="false" aria-controls="collapseTwoNew">
                                                    Public Certificate
                                                </button>
                                            </h5>
                                        </div>
                                        <div id="collapseTwoNew" class="collapse" aria-labelledby="headingTwoNew" data-parent="#accordion">
                                            <div class="card-body publicKey">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                </div>
                        </div>
                        <div class="modal-footer">
                            <button disabled type="button" class="btn btn-primary" data-step="initial" id="createKeysBtn"> Next </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="modal fade bd-example-modal-lg" id="publicCrtModal" tabindex="-1" role="dialog" aria-labelledby="publicCrtModal" aria-hidden="true">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel"> Upload your public certificate </h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div id="charge-form-wrapper">
                            <div class="modal-body" style="text-align: center;">
                                <p> Great! Please now proceed to upload the public certificate to your dashboard. </p>
                                <pre id="publicKey-modal"> </p>
                                <p> Make sure to keep your private key stored secretly.. </p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-dismiss="modal"> Done! </button>
                            </div>
                        <div>
                    </div>
                </div>
            </div>


    <script>
        
        /* 
        *  GLOBAL VARIABLES
        */
        let FSGlobal = {};
        let JsonEditor = {};
        let storefrontInitialLoad = true;
        
        function dataCallback(data) {
            FSGlobal = data;
            // If this is the first time the selected storefront is loaded
            // pre-populate the JSON editor with a valid payload
            if (storefrontInitialLoad) {
                prepopulateInitialPayload(data);
            }
        }

        </script>
    
        <script>
            function createKeys() {
                $.post(`${window.location.origin}/keys/new`)
                    .done((resKey) => {
                        if (resKey) {
                            $('#privateKey').html(`<pre>${resKey.privateKey}</pre>`);
                            $('#publicKey').html(`<pre>${resKey.publicCrt}</pre>`);
                            $('#publicKey-modal').html(resKey.publicCrt);
                            $('#publicCrtModal').modal('show');
                        } else {
                            console.log('eerr');
                        }
                    })
                    .fail(() => {
                        forceLogout('An unexpected server error occurred, please login again.');
                    });
            }

            function encryptPayload() {
                const JSONPayload = JsonEditor.get();
                // First check that it's a valid payload
                const isValidJSON = (payload) => {
                    try {
                        JSON.parse(rawPayload);
                    } catch (e) {
                        console.log(e.message, e.name);
                        return false;
                    }
                    return true;
                };
                // TODO add validation

                // Create AJAX request to our backend
                const Http = new XMLHttpRequest();
                    const url= `${window.location.origin}/encrypt`;
                    Http.open('POST', url, true);
                    Http.setRequestHeader("Content-Type", "application/json");
                   
                    Http.onreadystatechange = function(){
                        if (this.readyState === 4 && this.status === 200) {
                        const resEncrypted = JSON.parse(this.responseText);
                        
                        $('#encrypted-code').html(`
const securePayload = "${resEncrypted.securePayload}";
const secureKey = "${resEncrypted.secureKey}";

fastspring.builder.secure(securePayload, secureKey);
fastspring.builder.checkout();`);
}
                    };
                    Http.send(JSON.stringify(JSONPayload));
/*
                $.post(`${window.location.origin}/encrypt`, JSONpayload )
                    .done((resEncrypted) => {
                        if (resEncrypted) {
                        $('#encrypted-code').html(`
const securePayload = "${resEncrypted.securePayload}";
const secureKey = "${resEncrypted.secureKey}";

fastspring.builder.secure(securePayload, secureKey);
fastspring.builder.checkout();`);
                        } else {
                            console.log('eerr');
                        }
                    })
                    .fail(() => {
                        forceLogout('An unexpected server error occurred, please login again.');
                    });
                    */
            }

            function secureCall() {
                eval($("#encrypted-code").html());
            }
        </script>
    </body>
</html>
